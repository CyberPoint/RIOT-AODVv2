
import argparse
import traceback
import sys
import os
import xml.etree.ElementTree as ET

'''
TODO: kann ich auf fields auch iwie ueber den name anstatt index zugreifen?
'''

working_dir = "./dumps/"
xml_file_str = ""
packets = [] # store ALL the packets!

RFC5444_MSGTYPE_RREQ = 10
RFC5444_MSGTYPE_RREP = 11
RFC5444_MSGTYPE_RERR = 12

'''
take xml.etree.ElementTree.Element, turn it into a dict and store it in packets[]
'''
def store_pkt(packetbb):
    pkt = {}
    orignode = {}
    targnode = {}

    header = packetbb[0]
    tlvblock = packetbb[1]
    addrblock = packetbb[2]

    msg_type = header[0].attrib.get("show")
    hop_limit = header[-1].attrib.get("show")

    pkt["msg_type"] = msg_type
    pkt["hop_limit"] = hop_limit

    if(int(msg_type) == RFC5444_MSGTYPE_RREQ):
        orignode["addr"] = addrblock[3].get("show")
        targnode["addr"] = addrblock[4].get("show")        

        pkt["orignode"] = orignode
        pkt["targnode"] = targnode

        # TODO tlvs

    # TODO other pkt types

    print "\t", pkt

def pcap_to_xml(pcap_file_str):
    global working_dir, xml_file_str

    # make sure we have a directory to operate in
    if (not os.path.exists(working_dir)):
        os.makedirs(working_dir)

    xml_file_str = working_dir + pcap_file_str.split("/")[-1].split(".")[0] + ".xml"
    
    # make pcap python-readable by converting it to xml, store in file
    if (os.path.isfile(xml_file_str)):
        os.remove(xml_file_str)
    os.system("tshark -r %s -V -Y packetbb -T pdml >> %s" %(pcap_file_str, xml_file_str))

def handle_capture():
    tree = ET.parse(xml_file_str)
    root = tree.getroot()
    for packet in root:
        print packet.tag

        packetbb = packet[-1][-1]
        store_pkt(packetbb)

def main():
    pcap_file_str = ""
    
    parser = argparse.ArgumentParser(description='evaluate traffic generated by auto_test')
    parser.add_argument('-f','--file', type=str, help='pcap file to evaluate')

    args = parser.parse_args()
    pcap_file_str = args.file

    pcap_to_xml(pcap_file_str)
    handle_capture()

if __name__ == "__main__":
    main()